<!DOCTYPE html>
<html>

<head>
    <title>Sheet {{ sheet.number }} - Curling Camera</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        .nav {
            margin-bottom: 20px;
        }

        .nav a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cameras-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .camera-card {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .camera-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .status {
            font-size: 0.9em;
        }

        .status.calibrated {
            color: green;
        }

        .status.uncalibrated {
            color: red;
        }

        .img-preview {
            width: 100%;
            height: auto;
            max-height: 400px;
            background: #ddd;
            object-fit: contain;
            margin-top: 15px;
            border: 1px solid #ccc;
        }

        .img-preview.secondary {
            border-color: #94c0ff;
        }

        .preview-grid {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .preview-label {
            font-size: 0.85em;
            font-weight: bold;
            color: #555;
            margin-top: 10px;
        }

        .actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .artifact-card {
            margin-top: 15px;
            padding: 12px;
            background: #f8fbff;
            border: 1px solid #cfe2ff;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .pending-card {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #f0a500;
            border-radius: 6px;
            background: #fff9e6;
        }

        .pending-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 10px;
            color: #a06200;
        }

        .pending-meta {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
        }

        .artifact-path {
            font-family: monospace;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .artifact-notes {
            margin-top: 6px;
        }

        button {
            cursor: pointer;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            font-size: 1em;
        }

        button:hover {
            background: #0056b3;
        }

        .timestamp {
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .scan-status {
            margin-top: 8px;
            font-size: 0.85em;
            color: #555;
        }

        .scan-results {
            margin-top: 8px;
            font-size: 0.85em;
            color: #333;
        }

        .scan-results button {
            margin-top: 4px;
            padding: 4px 8px;
            font-size: 0.85em;
            background: #f1f5ff;
            color: #0b4aa7;
            border: 1px solid #c3d4ff;
        }
    </style>
</head>

<body>
    <div class="nav">
        <a href="{% url 'dashboard' %}">&larr; Back to Sheet List</a>
    </div>

    <div class="header">
        <h1>Sheet {{ sheet.number }}</h1>
    </div>

    <div class="cameras-container">
        {% for entry in camera_cards %}
        {% with camera=entry.camera last_frame=entry.last_frame artifact=entry.last_artifact %}
        <div class="camera-card">
            <div class="camera-header">
                <span>{{ camera.get_side_display }} Camera</span>
                <span class="status {% if camera.is_calibrated %}calibrated{% else %}uncalibrated{% endif %}">
                    {% if camera.is_calibrated %}Calibrated{% else %}Not Calibrated{% endif %}
                </span>
            </div>
            <div style="font-size:0.9em;color:#555;margin-bottom:10px;">
                Source:
                {% if camera.snapshot_url %}
                HTTP snapshot (<code>{{ camera.snapshot_url }}</code>)
                {% else %}
                Not configured
                {% endif %}
            </div>

            <div style="margin-bottom: 15px;">
                <form action="{% url 'update_camera' %}" method="post" id="camera_source_form_{{ camera.side }}">
                    {% csrf_token %}
                    <input type="hidden" name="sheet_id" value="{{ sheet.number }}">
                    <input type="hidden" name="side" value="{{ camera.side }}">
                    <label for="snapshot_url_{{ camera.side }}" style="display:block;margin-top:0;">Snapshot URL:</label>
                    <input type="url"
                           name="snapshot_url"
                           id="snapshot_url_{{ camera.side }}"
                           value="{{ camera.snapshot_url|default:'' }}"
                           placeholder="http://camera.local/latest.jpg"
                           style="width:100%;padding:6px;margin-top:4px;">
                    <small style="display:block;color:#666;margin-top:4px;">Frames are always fetched from this HTTP endpoint.</small>
                    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button type="submit">Save Source</button>
                        <button type="button" onclick="scanNetworkForCamera('{{ camera.side }}')">Scan Network</button>
                    </div>
                    <div class="scan-status" id="scan_status_{{ camera.side }}"></div>
                    <div class="scan-results" id="scan_results_{{ camera.side }}"></div>
                </form>
            </div>

            {% if last_frame %}
            <div class="preview-grid">
                {% if last_frame %}
                <div>
                    <div class="preview-label">Captured Frame</div>
                    <img src="{{ last_frame.image.url }}" class="img-preview">
                </div>
                {% if last_frame.rectified_image %}
                <div>
                    <div class="preview-label">Rectified Frame</div>
                    <img src="{{ last_frame.rectified_image.url }}" class="img-preview secondary">
                </div>
                {% endif %}
                {% endif %}
            </div>
            <div class="timestamp">Last captured: {{ last_frame.timestamp }}</div>
            {% else %}
            <div class="img-preview"
                style="display:flex;align-items:center;justify-content:center;color:#999;height:300px;">
                No Image Available
            </div>
            {% endif %}

            {% if artifact %}
            <div class="artifact-card">
                <div><strong>Last calibration:</strong> {{ artifact.created_at|date:"Y-m-d H:i" }}</div>
                <div>Type: {{ artifact.get_artifact_type_display }}</div>
                {% if artifact.artifact_file %}
                <div class="artifact-path">File: {{ artifact.artifact_file }}</div>
                {% endif %}
                {% if artifact.notes %}
                <div class="artifact-notes">{{ artifact.notes }}</div>
                {% endif %}
            </div>
            {% endif %}

            {% if entry.pending_session %}
            <div class="pending-card">
                <div class="pending-header">
                    <span>Pending calibration ({{ entry.pending_session.created_at|date:"Y-m-d H:i" }})</span>
                    <span>Click Accept to apply</span>
                </div>
                <div class="preview-grid">
                    <div>
                        <div class="preview-label">Source Frame</div>
                        <img src="{{ entry.pending_session.source_image.url }}" class="img-preview">
                    </div>
                    {% if entry.pending_session.rectified_preview %}
                    <div>
                        <div class="preview-label">Rectified Preview</div>
                        <img src="{{ entry.pending_session.rectified_preview.url }}" class="img-preview secondary">
                    </div>
                    {% endif %}
                </div>
                <div class="pending-meta">
                    <div>Fit error: {{ entry.pending_session.fit_error|default:"-" }}</div>
                    {% if entry.pending_meta.crop_text %}
                    <div>Crop: {{ entry.pending_meta.crop_text }}</div>
                    {% endif %}
                    {% if entry.pending_meta.best_combo %}
                    <div>Lens combo (f, k1, k2): {{ entry.pending_meta.best_combo }}</div>
                    {% endif %}
                    {% if entry.pending_meta.auto_features %}
                    <div>Auto-detected sheet edges, lines, and houses are stored with this session.</div>
                    {% endif %}
                </div>
                <div class="actions" style="margin-top: 10px;">
                    <form action="{% url 'accept_calibration' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="session_id" value="{{ entry.pending_session.id }}">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit">Accept</button>
                    </form>
                    <form action="{% url 'reject_calibration' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="session_id" value="{{ entry.pending_session.id }}">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit">Reject</button>
                    </form>
                </div>
            </div>
            {% endif %}

            <div class="actions">
                <form action="{% url 'start_calibration' sheet.number camera.side %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Run Auto Calibration</button>
                </form>
                {% if camera.motion_capture_pid %}
                <form action="{% url 'stop_motion_capture' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="sheet_id" value="{{ sheet.number }}">
                    <input type="hidden" name="side" value="{{ camera.side }}">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit">Stop Motion Capture</button>
                </form>
                {% else %}
                <form action="{% url 'motion_capture' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="sheet_id" value="{{ sheet.number }}">
                    <input type="hidden" name="side" value="{{ camera.side }}">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit">Start Motion Capture</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endwith %}
        {% endfor %}
    </div>
</body>

<script>
    const scanEndpoint = "{% url 'scan_snapshot_cameras' %}";

    function scanNetworkForCamera(side) {
        const statusEl = document.getElementById(`scan_status_${side}`);
        const resultsEl = document.getElementById(`scan_results_${side}`);
        const form = document.getElementById(`camera_source_form_${side}`);
        if (!statusEl || !resultsEl) {
            return;
        }
        if (!form) {
            console.warn(`Missing form for ${side} camera`);
        }
        statusEl.textContent = 'Scanning local network for snapshot cameras...';
        resultsEl.innerHTML = '';
        fetch(scanEndpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Scan failed');
                }
                return response.json();
            })
            .then(data => {
                const subnet = data.subnet || 'local network';
                const hosts = data.hosts || [];
                if (!hosts.length) {
                    statusEl.textContent = `No snapshot servers responded on ${subnet}.`;
                    return;
                }
                statusEl.textContent = `Found ${hosts.length} server(s) on ${subnet}. Click to use:`;
                const fragment = document.createDocumentFragment();
                hosts.forEach(host => {
                    const wrap = document.createElement('div');
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = host.url;
                    button.addEventListener('click', () => applySnapshotUrl(side, host.url));
                    wrap.appendChild(button);
                    fragment.appendChild(wrap);
                });
                resultsEl.innerHTML = '';
                resultsEl.appendChild(fragment);
            })
            .catch(err => {
                console.error(err);
                statusEl.textContent = 'Unable to scan the network for cameras.';
            });
    }

    function applySnapshotUrl(side, url) {
        const input = document.getElementById(`snapshot_url_${side}`);
        const form = document.getElementById(`camera_source_form_${side}`);
        const statusEl = document.getElementById(`scan_status_${side}`);
        if (!input || !form) {
            console.warn(`Unable to apply snapshot URL for ${side}`);
            return;
        }
        input.value = url;
        if (statusEl) {
            statusEl.textContent = 'Using ' + url + '...';
        }
        form.submit();
    }
</script>

</html>